---
  - trigger:
      - platform: time_pattern
        hours: "*"
        minutes: "*"
        seconds: "/30"
    sensor:
      - name: "Heating_calculation_all"
        state: >
          {# get list of available thermostats and get TARGET templerature #}
          {% set temp = expand('group.Thermostats')
          | rejectattr('state', 'in', ['unavailable', 'unknown', 'off'])
          | map(attribute='attributes.temperature') 
          | list %}
          {# get list of available thermostats and get CURRENT templerature #}
          {% set curr = expand('group.Thermostats')
          | rejectattr('state', 'in', ['unavailable', 'unknown', 'off'])
          | map(attribute='attributes.current_temperature') | list %}
          {# check, if there are any thermostats that can be used #}
          {% if (temp|length) > 0 %}
            {% set result = namespace( value = 0) %}
            {% for t in temp %}
              {% set rate = (curr[loop.index0] - temp[loop.index0]) %}
              {# when temp is below target value #}
              {% if rate < 0 %}
                {% set result.value = result.value + rate|abs %}
              {% endif %}
              {# at the end of the loop #}
              {% if loop.last %}
                {{ result.value | round(2) }}
              {% endif %}
            {% endfor %}
          {% else %}
          {# if there are no thermostats that can be used for calculation #}
          -1
          {% endif %}
  - trigger:
      - platform: time_pattern
        hours: "*"
        minutes: "*"
        seconds: "/30"
    sensor:
      - name: "Heating_calculation_rooms"
        state: >
          {# get list of available thermostats and get TARGET templerature #}
          {% set temp = expand('group.RoomThermostats')
          | rejectattr('state', 'in', ['unavailable', 'unknown', 'off'])
          | map(attribute='attributes.temperature') 
          | list %}
          {# get list of available thermostats and get CURRENT templerature #}
          {% set curr = expand('group.RoomThermostats')
          | rejectattr('state', 'in', ['unavailable', 'unknown', 'off'])
          | map(attribute='attributes.current_temperature') | list %}
          {# check, if there are any thermostats that can be used #}
          {% if (temp|length) > 0 %}
            {% set result = namespace( value = 0) %}
            {% for t in temp %}
              {% set rate = (curr[loop.index0] - temp[loop.index0]) %}
              {# when temp is below target value #}
              {% if rate < 0 %}
                {% set result.value = result.value + rate|abs %}
              {% endif %}
              {# at the end of the loop #}
              {% if loop.last %}
                {{ result.value | round(2) }}
              {% endif %}
            {% endfor %}
          {% else %}
          {# if there are no thermostats that can be used for calculation #}
          -1
          {% endif %}
